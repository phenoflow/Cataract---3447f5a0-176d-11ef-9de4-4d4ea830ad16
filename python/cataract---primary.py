# Kuan V, Denaxas S, Gonzalez-Izquierdo A, Direk K, Bhatti O, Husain S, Sutaria S, Hingorani M, Nitsch D, Parisinos C, Lumbers T, Mathur R, Sofat R, Casas JP, Wong I, Hemingway H, Hingorani A, 2024.

import sys, csv, re

codes = [{"code":"1483","system":"readv2"},{"code":"7263011","system":"readv2"},{"code":"F464200","system":"readv2"},{"code":"F465.00","system":"readv2"},{"code":"F463400","system":"readv2"},{"code":"F46z.00","system":"readv2"},{"code":"F465z00","system":"readv2"},{"code":"F461B00","system":"readv2"},{"code":"F461300","system":"readv2"},{"code":"F463300","system":"readv2"},{"code":"2BT..00","system":"readv2"},{"code":"P33y000","system":"readv2"},{"code":"F464100","system":"readv2"},{"code":"F463200","system":"readv2"},{"code":"F461B11","system":"readv2"},{"code":"F461200","system":"readv2"},{"code":"F46..00","system":"readv2"},{"code":"F461400","system":"readv2"},{"code":"63640","system":"readv2"},{"code":"58625","system":"readv2"},{"code":"70201","system":"readv2"},{"code":"11255","system":"readv2"},{"code":"4358","system":"readv2"},{"code":"44260","system":"readv2"},{"code":"5361","system":"readv2"},{"code":"50932","system":"readv2"},{"code":"57805","system":"readv2"},{"code":"8130","system":"readv2"},{"code":"22022","system":"readv2"},{"code":"18048","system":"readv2"},{"code":"1622","system":"readv2"},{"code":"45190","system":"readv2"},{"code":"38641","system":"readv2"},{"code":"44294","system":"readv2"},{"code":"48192","system":"readv2"},{"code":"18089","system":"readv2"},{"code":"41668","system":"readv2"},{"code":"49554","system":"readv2"},{"code":"6330","system":"readv2"},{"code":"44794","system":"readv2"},{"code":"63212","system":"readv2"},{"code":"47566","system":"readv2"},{"code":"9931","system":"readv2"},{"code":"105971","system":"readv2"},{"code":"51162","system":"readv2"},{"code":"58078","system":"readv2"},{"code":"10659","system":"readv2"},{"code":"6876","system":"readv2"},{"code":"98962","system":"readv2"},{"code":"103508","system":"readv2"},{"code":"59125","system":"readv2"},{"code":"44982","system":"readv2"},{"code":"11941","system":"readv2"},{"code":"92358","system":"readv2"},{"code":"90279","system":"readv2"},{"code":"54130","system":"readv2"},{"code":"70700","system":"readv2"},{"code":"4148","system":"readv2"},{"code":"88738","system":"readv2"},{"code":"33482","system":"readv2"},{"code":"6317","system":"readv2"},{"code":"15589","system":"readv2"},{"code":"70403","system":"readv2"},{"code":"62188","system":"readv2"},{"code":"29770","system":"readv2"},{"code":"49085","system":"readv2"},{"code":"69278","system":"readv2"},{"code":"24467","system":"readv2"},{"code":"96385","system":"readv2"},{"code":"63491","system":"readv2"},{"code":"99424","system":"readv2"},{"code":"19371","system":"readv2"},{"code":"49297","system":"readv2"},{"code":"104553","system":"readv2"},{"code":"70257","system":"readv2"},{"code":"26850","system":"readv2"},{"code":"703","system":"readv2"},{"code":"93727","system":"readv2"},{"code":"100770","system":"readv2"},{"code":"5325","system":"readv2"},{"code":"26097","system":"readv2"},{"code":"45926","system":"readv2"},{"code":"94430","system":"readv2"},{"code":"44779","system":"readv2"},{"code":"94348","system":"readv2"},{"code":"89585","system":"readv2"},{"code":"23883","system":"readv2"},{"code":"60425","system":"readv2"},{"code":"4459","system":"readv2"},{"code":"71623","system":"readv2"},{"code":"94474","system":"readv2"},{"code":"48228","system":"readv2"},{"code":"6547","system":"readv2"},{"code":"101939","system":"readv2"},{"code":"23631","system":"readv2"},{"code":"46169","system":"readv2"},{"code":"39081","system":"readv2"},{"code":"48148","system":"readv2"},{"code":"59914","system":"readv2"},{"code":"296","system":"readv2"},{"code":"110400","system":"readv2"},{"code":"4260","system":"readv2"},{"code":"63429","system":"readv2"},{"code":"299","system":"readv2"},{"code":"45952","system":"readv2"},{"code":"7257","system":"readv2"},{"code":"10010","system":"readv2"},{"code":"64196","system":"readv2"},{"code":"61325","system":"readv2"},{"code":"71291","system":"readv2"},{"code":"33793","system":"readv2"},{"code":"60883","system":"readv2"},{"code":"7793","system":"readv2"},{"code":"17545","system":"readv2"},{"code":"11767","system":"readv2"},{"code":"27898","system":"readv2"},{"code":"42452","system":"readv2"},{"code":"44487","system":"readv2"},{"code":"4242","system":"readv2"},{"code":"H26.2","system":"readv2"},{"code":"C73.1","system":"readv2"},{"code":"C71.3","system":"readv2"},{"code":"C74.3","system":"readv2"},{"code":"C71.2","system":"readv2"},{"code":"C77.2","system":"readv2"},{"code":"C74.1","system":"readv2"}];
REQUIRED_CODES = 1;
with open(sys.argv[1], 'r') as file_in, open('cataract-potential-cases.csv', 'w', newline='') as file_out:
    csv_reader = csv.DictReader(file_in)
    csv_writer = csv.DictWriter(file_out, csv_reader.fieldnames + ["cataract---primary-identified"])
    csv_writer.writeheader();
    codes_identified = 0;
    for row in csv_reader:
        newRow = row.copy();
        for cell in row:
            # Iterate cell lists (e.g. codes)
            for item in re.findall(r'\(([^,]*)\,', row[cell]):
                if(item in list(map(lambda code: code['code'], codes))): codes_identified+=1;
                if(codes_identified>=REQUIRED_CODES):
                    newRow["cataract---primary-identified"] = "CASE";
                    break;
            if(codes_identified>=REQUIRED_CODES): break;
        if(codes_identified<REQUIRED_CODES):
            newRow["cataract---primary-identified"] = "UNK";
        codes_identified=0;
        csv_writer.writerow(newRow)
